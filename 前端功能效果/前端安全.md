# 前端安全

## xss 跨站脚本攻击

**攻击者注入恶意脚本,用户浏览时执行,可能窃取 Cookie、篡改页面或发起伪造操作**

如何防御: 

1. 服务器设置 CSP：在 HTTP 头中配置 Content-Security-Policy,限制脚本来源, 防止执行恶意代码

2. 给 Cookie 设置 HttpOnly, 防止 JS 获取

3. 谨慎使用 v-html：渲染用户输入的 HTML, 要先用 DOMPurify 库净化

实际应用场景: 

1. 文章富文本

用户或管理员发布的文章可能包含格式化文本和图片,渲染时使用 v-html，先用编辑器或 DOMPurify 做安全过滤，禁止 <script>、<iframe> 等危险标签

意识到问题：直接渲染用户 HTML 不安全，可能被注入 <script>、<iframe> 或事件属性。

编辑器端过滤（可选）：在 WangEditor 中限制允许的标签和属性，只保留必要的格式和图片，过滤危险标签
```js
import E from 'wangeditor'

const editor = new E('#editor')

// 配置菜单，只允许必要功能
editor.config.menus = [
  'bold', 'italic', 'underline', 'head', 'link', 'list', 'quote', 'image'
]

// 粘贴过滤，移除危险标签
editor.config.pasteTextHandle = function (pasteStr) {
  return pasteStr.replace(/<(script|iframe|style)[\s\S]*?>[\s\S]*?<\/\1>/gi, '')
}

editor.create()

```

渲染端二次清理（必须）：用 DOMPurify 做白名单过滤，即使用户绕过编辑器也能防止注入攻击。

```js
import DOMPurify from 'dompurify'

export default {
  props: {
    content: String  // 后端返回的文章 HTML
  },
  computed: {
    safeContent() {
      return DOMPurify.sanitize(this.content, {
        ALLOWED_TAGS: [
          'b','i','em','strong','a','p','ul','ol','li','br','img','blockquote','h1','h2','h3'
        ],
        ALLOWED_ATTR: ['href','src','alt','title','target']
      })
    }
  }
}
```

安全渲染：处理后的 HTML 通过 v-html 渲染，既安全又保留格式和图片

2. 无感知 Token 刷新机制：用户登录后，长 Token（Refresh Token）存 Cookie，并设置 HttpOnly（前端不可访问）和 SameSite=Lax/Strict（防止跨站请求携带）。同源请求自动带 Cookie，同时前端在请求头携带随机生成的 CSRF Token，防止 XSS 或 CSRF 攻击窃取或滥用 Token

## CSRF 跨站请求伪造

**攻击者利用用户登录状态自动带的 Cookie，伪造请求冒充用户操作**

如何防御: 

1. CSRF Token：服务器给每个用户会话生成唯一 token，请求时带上，服务器验证合法性。

2. 设置 Cookie 的 SameSite 属性为 Strict 或 Lax，防止跨站请求自动带上 Cookie

Strict 完全不在跨站请求中带 Cookie,最安全；Lax 允许部分安全导航请求带 Cookie,一般用 Lax 平衡安全和体验

### 常见攻击方式

在现代 Vue SPA 中，传统 CSRF 攻击方式主要是

GET 请求伪造：通过 <img>、<a>、<script> 等方式自动请求

POST 请求伪造：通过隐藏表单 + JavaScript 自动提交

实际运用场景:

1. 用户资料修改, 密码修改

Vue + Axios 调用接口修改用户资料
```js
axios.post('/api/user/update', {
  nickname: '哥',
  email: 'me@example.com'
})
```
如果后端只依赖 Cookie 做认证，攻击者在恶意网站放一个表单：

```js
<form action="https://yourapp.com/api/user/update" method="POST">
  <input type="hidden" name="nickname" value="黑客" />
  <input type="hidden" name="email" value="hacker@evil.com" />
  <input type="submit" />
</form>
```

1. 双 Cookie 校验 核心是防 CSRF

HttpOnly Cookie 防止 XSS 窃取敏感凭证

前端可读 Cookie 只是携带 CSRF Token，不存敏感信息


2. 敏感操作二次验证 → 即使 Token 被窃取，也无法直接操作