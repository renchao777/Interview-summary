# 大文件上传

文件上传的原理可以分为几个主要步骤，包括文件的分片、上传、以及断点续传等。以下是详细的解释：

1. 文件选择与分片
   文件选择：用户通过 <input type="file"> 选择要上传的文件
   分片处理：将大文件分成多个小片段（chunk），例如每个片段大小设定为 5MB。使用 File.slice() 方法切割文件
2. 上传片段（循环上传）
   片段上传：每个片段通过 FormData 对象发送到服务器，包含片段索引、总片段数和文件名等信息
3. 断点续传
   记录已上传片段：将已上传片段的索引存储在 localStorage 或服务器缓存中，以便跟踪
   恢复上传：若上传中断，下次上传时检查已上传的片段，从最后一个未上传的片段继续
4. 文件拼接
   合并片段：服务器在所有片段上传完成后，将它们按照正确顺序合并为完整文件
   验证与完成：合并后，服务器进行文件完整性验证，确保传输过程中文件未损坏

```vue
<template>
  <div>
    <input type="file" @change="onFileChange" accept="*/*" />
    <progress :value="progress" max="100"></progress>
  </div>
</template>

<script>
export default {
  data() {
    return {
      file: null, // 选择的文件
      chunkSize: 5 * 1024 * 1024, // 每个分片大小（5MB）
      progress: 0, // 上传进度
      uploadedChunks: [], // 已上传分片的索引
    };
  },
  methods: {
    // 文件选择后的处理函数
    onFileChange(event) {
      this.file = event.target.files[0];
      if (this.file) {
        this.loadUploadedChunks(); // 加载已上传分片
        this.uploadFile(); // 开始上传文件
      }
    },

    // 加载已上传的分片索引
    loadUploadedChunks() {
      const uploadedChunks = localStorage.getItem(this.file.name);
      this.uploadedChunks = uploadedChunks ? JSON.parse(uploadedChunks) : [];
    },

    // 保存已上传的分片索引
    saveUploadedChunk(index) {
      this.uploadedChunks.push(index);
      localStorage.setItem(this.file.name, JSON.stringify(this.uploadedChunks));
    },

    // 上传文件的主逻辑
    async uploadFile() {
      const totalChunks = Math.ceil(this.file.size / this.chunkSize); // 计算总分片数

      for (let i = 0; i < totalChunks; i++) {
        if (this.uploadedChunks.includes(i)) continue; // 跳过已上传的分片

        // 切割文件分片
        const chunk = this.file.slice(
          i * this.chunkSize,
          (i + 1) * this.chunkSize
        );
        const formData = new FormData();
        formData.append("file", chunk);
        formData.append("chunkIndex", i);
        formData.append("totalChunks", totalChunks);
        formData.append("fileName", this.file.name);

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("Upload failed"); // 上传失败

          this.saveUploadedChunk(i); // 记录已上传分片
          this.progress = (this.uploadedChunks.length / totalChunks) * 100; // 更新进度
        } catch (error) {
          console.error(`Error uploading chunk ${i}:`, error); // 错误处理
        }
      }

      alert("上传完成！"); // 上传完成提示
      localStorage.removeItem(this.file.name); // 清除记录
    },
  },
};
</script>
```
